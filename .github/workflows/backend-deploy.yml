name: DeployÂ 



on:

Â  push:

Â  Â  branches: [ main ]

Â  Â  paths:Â Â 

Â  Â  Â  - 'src/**'

Â  Â  Â  - 'build.gradle'

Â  Â  Â  - 'Dockerfile'

Â  Â  Â  - 'settings.gradle'Â 

Â  Â  Â  - 'gradlew'

Â  Â  Â  - '.gradlew' # (hidden file in case of mvnw)



jobs:

Â  deploy:

Â  Â  runs-on: ubuntu-latest

Â  Â Â 

Â  Â  steps:

Â  Â  - name: Checkout code

Â  Â  Â  uses: actions/checkout@v4 # ğŸ’¡ GitHub Actions Runnerì— ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•˜ëŠ” ë‹¨ê³„ ì¶”ê°€



Â  Â  - name: Deploy to Azure VM

Â  Â  Â  uses: appleboy/ssh-action@v0.1.10

Â  Â  Â  with:

Â  Â  Â  Â  host: ${{ secrets.SERVER_HOST }}

Â  Â  Â  Â  username: ${{ secrets.SERVER_USER }}

Â  Â  Â  Â  key: ${{ secrets.SERVER_SSH_KEY }}

Â  Â  Â  Â  port: 22

Â  Â  Â  Â  timeout: 300s

Â  Â  Â  Â  script: |

Â  Â  Â  Â  Â  echo "ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."

Â  Â  Â  Â  Â  cd /home/youkm0806/matchalotÂ  Â  Â  Â  Â 

Â  Â  Â  Â  Â  git fetch origin main # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°

Â  Â  Â  Â  Â  git reset --hard origin/main # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë²„ë¦¬ê³  main ë¸Œëœì¹˜ì™€ ë™ì¼í•˜ê²Œ ë§ì¶”ê¸°

Â  Â  Â  Â  Â  git clean -fd # ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼/ë””ë ‰í† ë¦¬ ì œê±° (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¹”ë”í•œ ë¹Œë“œì— ì¢‹ìŒ)

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  echo "Backend ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."

Â  Â  Â  Â  Â  ./gradlew bootJar # ë˜ëŠ” í”„ë¡œì íŠ¸ ì„¤ì •ì— ë”°ë¼ ./gradlew build



Â  Â  Â  Â  Â  echo "Docker Compose ë°°í¬ ì¤‘..."

Â  Â  Â  Â  Â  cd devopsÂ Â 

Â  Â  Â  Â  Â  docker-compose down

Â  Â  Â  Â  Â  docker-compose up --build -d # --build ì˜µì…˜ì´ ì¬ë¹Œë“œë¥¼ íŠ¸ë¦¬ê±°



Â  Â  Â  Â  Â  echo "í—¬ìŠ¤ì²´í¬ ì¤‘..."

Â  Â  Â  Â  Â  sleep 30

Â  Â  Â  Â  Â  curl -f http://localhost:8080/actuator/health

Â  Â  Â  Â  Â  echo "ë°°í¬ ì„±ê³µ!"
