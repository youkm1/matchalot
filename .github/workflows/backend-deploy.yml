name: Backend Deploy to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    - name: Run tests
      run: ./gradlew test -Dspring.profiles.active=test
      
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    name: Build and Deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    - name: Build application
      run: ./gradlew clean build -x test -Dspring.profiles.active=prod
      
    - name: Build Docker image
      run: |
        docker build -t matchalot-backend:latest .
        docker tag matchalot-backend:latest matchalot-backend:${{ github.sha }}
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          sudo docker stop matchalot-backend || true
          sudo docker rm matchalot-backend || true
          
          # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±° (ì„ íƒì )
          sudo docker rmi matchalot-backend:latest || true
          
          # ìƒˆ ì½”ë“œ pull
          cd /home/ubuntu/matchalot
          git pull origin main
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          sudo docker build -t matchalot-backend:latest .
          
          # .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -f .env ]; then
            echo ".env íŒŒì¼ ë°œê²¬ë¨"
            # .env íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d \
              --name matchalot-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file .env \
              matchalot-backend:latest
          else
            echo ".env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í™˜ê²½ë³€ìˆ˜ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
            # ê¸°ë³¸ í™˜ê²½ë³€ìˆ˜ë¡œ ì‹¤í–‰
            sudo docker run -d \
              --name matchalot-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              matchalot-backend:latest
          fi
          
          sleep 30
          curl -f http://localhost:8080/actuator/health || exit 1
          
          echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
          sudo docker logs --tail 10 matchalot-backend
          
          # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
          sudo docker image prune -f
          
    - name: Notify deployment success
      if: success()
      run: |
        echo "Deployment successful!"
        echo "Backend is now running on production server"
        
    - name: Notify deployment failure  
      if: failure()
      run: |
        echo "Deployment failed!"
        echo "Please check the logs and fix the issues"
