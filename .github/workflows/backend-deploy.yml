# .github/workflows/backend-deploy.yml
# ğŸ¯ ê¸°ì¡´ Docker Compose ìœ ì§€ + Jenkins ëŒ€ì²´
name: Backend CI/CD (Docker Compose Compatible)

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'gradle/**'
      - 'Dockerfile'
  pull_request:
    branches: [main]

env:
  # ğŸ›ï¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„ íƒ (ê¸°ì¡´ Docker Hub ë°©ì‹ ìœ ì§€)
  IMAGE_NAME: matchalot-backend
  # Option 1: Docker Hub (ê¸°ì¡´ê³¼ ë™ì¼)
  DOCKER_REGISTRY: ""
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/matchalot-backend
  
  # Option 2: GHCR (ë¬´ë£Œ, ì œí•œ ì—†ìŒ)
  # DOCKER_REGISTRY: ghcr.io
  # DOCKER_IMAGE: ghcr.io/${{ github.repository }}/matchalot-backend

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ & ë¹Œë“œ
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run tests
        run: ./gradlew clean test
        
      - name: Build JAR
        run: ./gradlew build -x test
        
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: build/reports/
          
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/*.jar

  # ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ (ê¸°ì¡´ Jenkins ì—­í• )
  docker-build-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # Docker Hub ë¡œê·¸ì¸ (ê¸°ì¡´ ë°©ì‹)
      - name: Login to Docker Hub
        if: env.DOCKER_REGISTRY == ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # GHCR ë¡œê·¸ì¸ (ëŒ€ì•ˆ)
      - name: Login to GitHub Container Registry
        if: env.DOCKER_REGISTRY == 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # ğŸ·ï¸ Docker ë©”íƒ€ë°ì´í„° ìƒì„± (íƒœê·¸ ê´€ë¦¬)
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.run_number }}
            
      # ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ (ê¸°ì¡´ Jenkinsì™€ ë™ì¼í•œ ê²°ê³¼)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64  # ë‹¨ì¼ í”Œë«í¼ìœ¼ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ğŸš€ ë¹Œë“œ ìµœì í™”
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ğŸš€ ì„œë²„ ë°°í¬ (ê¸°ì¡´ docker-compose ë°©ì‹ ì™„ì „ í˜¸í™˜)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker-build-push
    environment:
      name: production
      url: https://matchalot.duckdns.org
      
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # ğŸ¯ ê¸°ì¡´ Jenkins ìŠ¤í¬ë¦½íŠ¸ì™€ ë™ì¼í•œ ë¡œì§
            cd /opt/matchalot/devops
            
            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
            if [ -f .env ]; then
                source .env
            fi
            
            # ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼í•œ ë°°í¬ ë°©ì‹
            echo "ğŸ³ ìƒˆ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker-compose pull backend
            
            echo "ğŸš€ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            docker-compose up -d backend
            
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f
            
            echo "ğŸ“Š ë°°í¬ ì™„ë£Œ - ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker-compose ps backend
            
      - name: Health check
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          max_retries=6
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œë„ $((retry_count + 1))/$max_retries..."
            
            if curl --silent --fail https://matchalot.duckdns.org/actuator/health && \
               curl --silent --fail https://matchalot.duckdns.org/api/v1/study-materials/subjects; then
              echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
              exit 0
            fi
            
            retry_count=$((retry_count + 1))
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨, 15ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 15
          done
          
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨! í—¬ìŠ¤ì²´í¬ë¥¼ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          exit 1

  # ğŸ“Š ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ (ê¸°ì¡´ Jenkinsì˜ ì •ë¦¬ ì‘ì—…)
  post-deploy-cleanup:
    name: Post-Deploy Monitoring & Cleanup
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
      - name: Server cleanup and monitoring
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /opt/matchalot/devops
            
            echo "ğŸ“Š í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ:"
            echo "ğŸ³ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker-compose ps
            
            echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
            free -h
            
            echo "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
            df -h /
            
            echo "ğŸ” ë°±ì—”ë“œ ë¡œê·¸ (ìµœê·¼ 10ì¤„):"
            docker-compose logs --tail=10 backend
            
            # ğŸ§¹ ì‹œìŠ¤í…œ ì •ë¦¬ (ê¸°ì¡´ Jenkins ì •ë¦¬ ì‘ì—…ê³¼ ë™ì¼)
            echo "ğŸ§¹ Docker ì‹œìŠ¤í…œ ì •ë¦¬..."
            docker system prune -f --volumes || true
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (5ê°œ ì´ìƒ ë³´ê´€ ì‹œ)
            echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬..."
            docker images ${{ env.DOCKER_IMAGE }} --format "table {{.Repository}}:{{.Tag}}" | \
            grep -E "${{ env.DOCKER_IMAGE }}:[0-9]+" | \
            sort -r | \
            tail -n +6 | \
            xargs --no-run-if-empty docker rmi || true

  # ğŸ‰ Discord ì•Œë¦¼ (ê¸°ì¡´ Jenkins ì•Œë¦¼ê³¼ ë™ì¼)
  notify-discord:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-cleanup]
    if: always()
    
    steps:
      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ë°°í¬ ê²°ê³¼ íŒë‹¨
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            TITLE="ğŸš€ Backend ë°°í¬ ì„±ê³µ!"
            COLOR=3066993
            DESCRIPTION="í”„ë¡œë•ì…˜ í™˜ê²½ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            EMOJI="âœ…"
          else
            TITLE="ğŸ’¥ Backend ë°°í¬ ì‹¤íŒ¨!"
            COLOR=15158332
            DESCRIPTION="ë°°í¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            EMOJI="âŒ"
          fi
          
          # ì»¤ë°‹ ì •ë³´
          COMMIT_AUTHOR="${{ github.actor }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          BUILD_NUMBER="${{ github.run_number }}"
          
          # Discord ë©”ì‹œì§€ (ê¸°ì¡´ Jenkins ì•Œë¦¼ê³¼ ë™ì¼í•œ ì •ë³´)
          cat << EOF > discord_payload.json
          {
            "embeds": [{
              "title": "${TITLE}",
              "description": "${DESCRIPTION}",
              "color": ${COLOR},
              "fields": [
                {
                  "name": "ğŸ¯ ë°°í¬ ë°©ì‹",
                  "value": "Docker Compose (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)",
                  "inline": false
                },
                {
                  "name": "ë¸Œëœì¹˜",
                  "value": "\`${{ github.ref_name }}\`",
                  "inline": true
                },
                {
                  "name": "ë¹Œë“œ ë²ˆí˜¸",
                  "value": "\`#${BUILD_NUMBER}\`",
                  "inline": true
                },
                {
                  "name": "ì»¤ë°‹ ì‘ì„±ì",
                  "value": "${COMMIT_AUTHOR}",
                  "inline": true
                },
                {
                  "name": "ì»¤ë°‹ ë©”ì‹œì§€",
                  "value": "${COMMIT_MSG}",
                  "inline": false
                },
                {
                  "name": "API í™•ì¸",
                  "value": "[Backend API](https://matchalot.duckdns.org)",
                  "inline": false
                },
                {
                  "name": "ğŸ’° ë¦¬ì†ŒìŠ¤ ì ˆì•½",
                  "value": "Jenkins ì„œë²„ ì œê±°ë¡œ ì›” $30-50 ì ˆì•½!",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          
          # Discord ì›¹í›… ì „ì†¡
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @discord_payload.json \
               "$WEBHOOK_URL" || echo "Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
