name: Deploy 



on:
      push:
            branches: [ main ]
            paths:  
                  - 'src/**'
                  - 'build.gradle'
                  - 'Dockerfile'
                  - 'settings.gradle'  
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4 

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "코드 업데이트 중..."
          cd /home/youkm0806/matchalot/backend
          git fetch origin main
          git reset --hard origin/main
          git clean -fd 
          
          echo "Backend 애플리케이션 빌드 중..."
          ./gradlew bootJar # 또는 프로젝트 설정에 따라 ./gradlew build

          echo "Docker Compose 배포하되 백엔드만 잠깐 꺼짐!"
          cd ../devops
          docker-compose down backend
          docker-compose up --build -d backend

          echo "헬스체크 중..."
          sleep 30
          docker-compose logs backend tail -10
          curl -f http://localhost:8080/actuator/health && echo "배포 성공" || echo "배포 실패"
