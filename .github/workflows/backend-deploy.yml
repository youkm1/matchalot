name: Backend Deploy to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'Dockerfile'
      - 'devops/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'Dockerfile'
      - 'devops/**'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    - name: Run tests with test profile
      run: ./gradlew test --info
      env:
        SPRING_PROFILES_ACTIVE: test
      
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    name: Build and Deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    - name: Build application for production
      run: ./gradlew clean build -x test --info
      env:
        SPRING_PROFILES_ACTIVE: prod
        
    - name: Verify build artifacts
      run: |
        echo "Build artifacts:"
        ls -la build/libs/
        echo "JAR file created: $(ls build/libs/*.jar)"
      
    - name: Test Docker build locally
      run: |
        echo "Testing Docker build..."
        docker build -t matchalot-backend:test .
        echo "Docker build successful"
        
    - name: Verify secrets
      run: |
        echo "ğŸ” Checking secrets availability..."
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "SERVER_HOST secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "SERVER_USER secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
          echo "SERVER_SSH_KEY secret is missing"
          exit 1
        fi
        echo "All required secrets are available"
        echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
        echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
        echo "SSH Key length: $(echo '${{ secrets.SERVER_SSH_KEY }}' | wc -c) characters"
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 300s
        command_timeout: 600s
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 300s
        command_timeout: 600s
        script: |
          echo "Starting deployment..."
          echo "Current directory: $(pwd)"
          echo "Current user: $(whoami)"
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •
          PROJECT_DIR="/home/youkm0806/matchalot"
          DEVOPS_DIR="${PROJECT_DIR}/devops"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (docker-compose ì´ë¦„ ì‚¬ìš©)
          echo "Stopping existing containers..."
          cd $DEVOPS_DIR || echo "DevOps directory not found yet"
          sudo docker-compose down || true
          
          # ë˜ëŠ” ê°œë³„ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          sudo docker stop matchalot-backend || true
          sudo docker rm matchalot-backend || true
          
          # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
          echo "Removing old images..."
          sudo docker rmi devops-backend:latest || true
          sudo docker rmi matchalot-backend:latest || true
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
          echo "Setting up project directory..."
          mkdir -p $PROJECT_DIR
          cd $PROJECT_DIR
          
          # Git ë¦¬í¬ì§€í† ë¦¬ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
          if [ -d ".git" ]; then
            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          else
            echo "Cloning repository..."
            git clone https://github.com/youkm0806/matchalot.git .
          fi
          
          # .env íŒŒì¼ í™•ì¸ (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ìˆìŒ)
          if [ -f .env ]; then
            echo ".env íŒŒì¼ ë°œê²¬ë¨ (ë£¨íŠ¸ ë””ë ‰í† ë¦¬)"
            echo ".env íŒŒì¼ ë‚´ìš© í™•ì¸ (ë¯¼ê°í•œ ì •ë³´ ì œì™¸):"
            grep -v -E "(PASSWORD|SECRET|KEY)" .env | head -5 || true
          else
            echo ".env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            ls -la
          fi
          
          # devops ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          echo "Moving to devops directory..."
          cd $DEVOPS_DIR
          
          # docker-compose íŒŒì¼ í™•ì¸
          if [ -f docker-compose.yml ]; then
            echo "docker-compose.yml íŒŒì¼ ë°œê²¬ë¨"
          else
            echo "docker-compose.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            ls -la
            exit 1
          fi
          
          # .env íŒŒì¼ì„ devops ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ (í•„ìš”í•œ ê²½ìš°)
          if [ -f ../.env ] && [ ! -f .env ]; then
            echo "Copying .env file to devops directory..."
            cp ../.env .env
          fi
          
          # Docker Composeë¡œ ë¹Œë“œ ë° ì‹¤í–‰
          echo "Building and starting services with docker-compose..."
          sudo docker-compose build backend
          sudo docker-compose up -d backend
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "Checking container status..."
          sudo docker-compose ps
          
          # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
          if sudo docker ps | grep matchalot-backend; then
            echo "Backend container is running"
          else
            echo "Backend container is not running. Checking logs..."
            sudo docker-compose logs backend
            exit 1
          fi
          
          # í—¬ìŠ¤ì²´í¬
          echo "Performing health check..."
          for i in {1..12}; do
            echo "Health check attempt $i/12..."
            if curl -f http://localhost:8080/actuator/health; then
              echo "Health check passed!"
              break
            elif [ $i -eq 12 ]; then
              echo "Health check failed after 12 attempts"
              echo "Container logs:"
              sudo docker-compose logs --tail 20 backend
              exit 1
            else
              echo "Waiting 10 seconds before next attempt..."
              sleep 10
            fi
          done
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "Final container status:"
          sudo docker-compose ps
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ìµœê·¼ ëª‡ ì¤„ë§Œ)
          echo "Backend logs (ìµœê·¼ 10ì¤„):"
          sudo docker-compose logs --tail 10 backend
          
          # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
          echo "Cleaning up old images..."
          sudo docker image prune -f
          
          echo "Deployment completed successfully!"
          
    - name: Notify deployment success
      if: success()
      run: |
        echo "Deployment successful!"
        echo "Backend is now running on production server"
        
    - name: Notify deployment failure  
      if: failure()
      run: |
        echo "Deployment failed!"
        echo "Please check the logs and fix the issues"
